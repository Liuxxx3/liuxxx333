# 无线网络嗅探基础

---

## 实验目的

- 认识常见无线网络设备，了解基本使用和配置方法；
- 掌握使用 USB 无线网卡进行无线网络嗅探的基本方法；
- 了解无线网络嗅探的常用故障排错技术；
- 了解使用 Wireshark 进行 802.11 协议分析的基本方法；

## 实验环境

- 可以开启监听模式、AP 模式和数据帧注入功能的 USB 无线网卡；
- Kali 虚拟机；
- python scapy；
- aircrack-ng系列软件；
- Wireshark；


## 实验过程

* 详细记录实验所使用的无线网卡基本信息

（1）无线网卡正反面高清照片；

<img src="image\1.png" />

<img src="image\2.png" />

（2）该网卡的硬件和软件特性支持情况；

插入该无线网卡

在kali虚拟机中安装usb无线网卡

输入`iw phy`来获取硬件和软件特性

```
Wiphy phy0
	max # scan SSIDs: 4
	max scan IEs length: 2257 bytes
	max # sched scan SSIDs: 0
	max # match sets: 0
	max # scan plans: 1
	max scan plan interval: -1
	max scan plan iterations: 0
	Retry short long limit: 2
	Coverage class: 0 (up to 0m)
	Device supports RSN-IBSS.
	Supported Ciphers:
		* WEP40 (00-0f-ac:1)
		* WEP104 (00-0f-ac:5)
		* TKIP (00-0f-ac:2)
		* CCMP-128 (00-0f-ac:4)
		* CCMP-256 (00-0f-ac:10)
		* GCMP-128 (00-0f-ac:8)
		* GCMP-256 (00-0f-ac:9)
	Available Antennas: TX 0 RX 0
	Supported interface modes:
		 * IBSS
		 * managed
		 * AP
		 * AP/VLAN
		 * monitor
		 * mesh point
	Band 1:
		Capabilities: 0x17e
			HT20/HT40
			SM Power Save disabled
			RX Greenfield
			RX HT20 SGI
			RX HT40 SGI
			RX STBC 1-stream
			Max AMSDU length: 3839 bytes
			No DSSS/CCK HT40
		Maximum RX AMPDU length 32767 bytes (exponent: 0x002)
		Minimum RX AMPDU time spacing: 2 usec (0x04)
		HT TX/RX MCS rate indexes supported: 0-7, 32
		Bitrates (non-HT):
			* 1.0 Mbps
			* 2.0 Mbps (short preamble supported)
			* 5.5 Mbps (short preamble supported)
			* 11.0 Mbps (short preamble supported)
			* 6.0 Mbps
			* 9.0 Mbps
			* 12.0 Mbps
			* 18.0 Mbps
			* 24.0 Mbps
			* 36.0 Mbps
			* 48.0 Mbps
			* 54.0 Mbps
		Frequencies:
			* 2412 MHz [1] (20.0 dBm)
			* 2417 MHz [2] (20.0 dBm)
			* 2422 MHz [3] (20.0 dBm)
			* 2427 MHz [4] (20.0 dBm)
			* 2432 MHz [5] (20.0 dBm)
			* 2437 MHz [6] (20.0 dBm)
			* 2442 MHz [7] (20.0 dBm)
			* 2447 MHz [8] (20.0 dBm)
			* 2452 MHz [9] (20.0 dBm)
			* 2457 MHz [10] (20.0 dBm)
			* 2462 MHz [11] (20.0 dBm)
			* 2467 MHz [12] (20.0 dBm) (no IR)
			* 2472 MHz [13] (20.0 dBm) (no IR)
			* 2484 MHz [14] (20.0 dBm) (no IR)
	Supported commands:
		 * new_interface
		 * set_interface
		 * new_key
		 * start_ap
		 * new_station
		 * new_mpath
		 * set_mesh_config
		 * set_bss
		 * authenticate
		 * associate
		 * deauthenticate
		 * disassociate
		 * join_ibss
		 * join_mesh
		 * set_tx_bitrate_mask
		 * frame
		 * frame_wait_cancel
		 * set_wiphy_netns
		 * set_channel
		 * set_wds_peer
		 * probe_client
		 * set_noack_map
		 * register_beacons
		 * start_p2p_device
		 * set_mcast_rate
		 * connect
		 * disconnect
		 * set_qos_map
		 * set_multicast_to_unicast
	Supported TX frame types:
		 * IBSS: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
		 * managed: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
		 * AP: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
		 * AP/VLAN: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
		 * mesh point: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
		 * P2P-client: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
		 * P2P-GO: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
		 * P2P-device: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0
	Supported RX frame types:
		 * IBSS: 0x40 0xb0 0xc0 0xd0
		 * managed: 0x40 0xd0
		 * AP: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0
		 * AP/VLAN: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0
		 * mesh point: 0xb0 0xc0 0xd0
		 * P2P-client: 0x40 0xd0
		 * P2P-GO: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0
		 * P2P-device: 0x40 0xd0
	software interface modes (can always be added):
		 * AP/VLAN
		 * monitor
	valid interface combinations:
		 * #{ AP, mesh point } <= 8,
		   total <= 8, #channels <= 1
	HT Capability overrides:
		 * MCS: ff ff ff ff ff ff ff ff ff ff
		 * maximum A-MSDU length
		 * supported channel width
		 * short GI for 40 MHz
		 * max A-MPDU length exponent
		 * min MPDU start spacing
	Device supports TX status socket option.
	Device supports HT-IBSS.
	Device supports SAE with AUTHENTICATE command
	Device supports low priority scan.
	Device supports scan flush.
	Device supports AP scan.
	Device supports per-vif TX power setting
	Driver supports full state transitions for AP/GO clients
	Driver supports a userspace MPM
	Device supports configuring vdev MAC-addr on create.
	Supported extended features:
		* [ RRM ]: RRM
		* [ FILS_STA ]: STA FILS (Fast Initial Link Setup)
		* [ CQM_RSSI_LIST ]: multiple CQM_RSSI_THOLD records
		* [ CONTROL_PORT_OVER_NL80211 ]: control port over nl80211
```

* 通过无线路由器后台管理界面截图的方式，展示 **自己搭建** 的无线网络的基本配置信息

使用openwrt搭建无线网络，无线网卡型号为RT2870/RT3070，驱动已装载rt2800usb

<img src="image\5.png" />

登录luci进行后台管理无线网络，下图为其基本设置及网络加密设置。其中加密方式为WPA-PSK/WPA2-PSK 

<img src="image\6.png" />

<img src="image\7.png" />

<img src="image\8.png" />

* 使用自己的网卡搭建无线网络，再用舍友的网卡用作监听模式

<img src="image\9.png" style="zoom:200%;" />

* asciinema视频连接：

https://asciinema.org/a/kx6CCfXAdT2ijwycZBcxbGxVo

* 使用 `Wireshark` 的 `802.11 PSK` 解密功能解密分析一个包含「浏览器访问 HTTP 明文通信网站的完整过程」的抓包结果文件；

<font color=red>由于使用苹果手机无法忘记无线网络，使用舍友手机进行此实验</font>

首先使用`airodump-ng wlan0mon --channel 10 -w saved`来对信道10（我搭建的无线网络选择的信道）进行抓包，看到自己的BSSID地址为80:1F:02:42:0D:45

<img src="image\11.png" />

在wireshark中添加密钥，加密类型选wpa-pwd，key的格式为“密码:BSSID”，以此来解密数据流使其info成为可读信息

<img src="image\20.png" />

使用 `wlan.fc.type_subtype ==0x08` 过滤出 Beacon frame来查找自己的bssid

<img src="image\12.png" />

找到自己的bssid后据此过滤掉其他bssid，为了找到完整访问cuc教务处的信息，使用过滤信息过滤其他ip地址和mac地址的相关信息，下面为访问过程。从三次握手（SYN发出）开始，到四次挥手（（FIN,ACK）收到）结束。

<img src="image\17.png" />

<img src="image\18.png" />

<img src="image\19.png" />

## 实验练习题

通过分析抓包保存的pcap文件：

- 查看统计当前信号覆盖范围内一共有多少独立的SSID？其中是否包括隐藏SSID？哪些无线热点是加密/非加密的？加密方式是否可知？

使用`airodump-ng wlan0mon -w saved`进行抓包，结果如下

<img src="image\10.png" />

如图，信号覆盖范围内一共有22个独立的SSID，其中存在ESSID长度为0的，为隐藏SSID；加密的热点采用了WPA2或者其他的加密方式，而非加密的热点为open；所以CUC-WIFI为非加密网络，其余为加密网络。加密方式可从ENC一列中得知。

<img src="image\13.png" />

<img src="image\14.png" />

如图所示，也可在wireshark中查看Privacy来观察是否加密

- 如何分析出一个指定手机在抓包时间窗口内在手机端的无线网络列表可以看到哪些SSID？这台手机尝试连接了哪些SSID？最终加入了哪些SSID？

如图，可看到下列SSID

<img src="image\16.png" style="zoom:50%;" />

使用 `wlam.fc.type_subtype==0x0b`过滤数据包，发现我的手机发出了authentication请求，证明我的手机向该AP发送了连接请求。而该AP也返回了身份验证帧回复，手机最终连接入该网络。

<img src="image\15.png" />

- SSID包含在哪些类型的802.11帧？

（1）Probe(request and response)

（2）Authenticate(request and response)

（3）信标帧(Beacons)

## 遇到的问题

* openwrt无法装载网卡驱动

解决方法：更换网卡

* 已经搭建好的无线网络忽然无法找到

在openwrt中输入下列命令重置一下无线网卡

```
ifconfig wlan0 down
ifconfig wlan0 up
```

等待一段时间后可找到自己的无线网络

## 参考资料

1.https://zhuanlan.zhihu.com/p/28423868（教你使用 asciinema 录制命令行操作）

2.https://blog.csdn.net/Small_dong_/article/details/50365382（802.11帧数据详细讲解）

3.https://blog.csdn.net/swyang1992/article/details/52688609（wireshark如何分析加密的WIFI数据包）

4.https://blog.csdn.net/caiqiiqi/article/details/79713387（wireshark过滤802.11的各种帧）